#!/bin/bash

set -e
set -x

<% if p("cluster.nodes").empty? %>
  cf enable-service-access $SERVICE_NAME
<% else %>
  <% p("cluster.nodes").each do |node| %>
    curl -X POST -H "Content-Type: application/json" http://<%= p("cluster.user") %>:<%= p("cluster.password") %>@<%= p("cluster.nodes")[0] %>:5984/_cluster_setup -d '{"action": "add_node", "host":"<%= node %>", "port": "5984", "username": "<%= p("cluster.user") %>", "password":"<%= p("cluster.password") %>"}'
  <% end %>
<% end %>
